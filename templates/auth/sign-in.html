{% extends "base.html" %}

{% block title %}Sign In - AI Card Creator{% endblock %}

{% block head %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create a new UI instance
        const authUI = new firebaseui.auth.AuthUI(firebase.auth());

        // Get the current mode from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'signin';

        // Update the page title and description based on mode
        const titleElement = document.getElementById('auth-title');
        const descElement = document.getElementById('auth-description');
        const switchModeElement = document.getElementById('switch-mode');
        const resetPasswordElement = document.getElementById('reset-password-container');

        if (mode === 'signup') {
            titleElement.textContent = 'Create Account';
            descElement.textContent = 'Sign up to start creating your own AI-powered trading cards';
            switchModeElement.innerHTML = 'Already have an account? <a href="/sign-in?mode=signin" class="text-blue-600 hover:text-blue-800">Sign in</a>';
            resetPasswordElement.style.display = 'none';
        } else {
            titleElement.textContent = 'Sign In';
            descElement.textContent = 'Welcome back! Sign in to access your collection';
            switchModeElement.innerHTML = 'New to AI Card Creator? <a href="/sign-in?mode=signup" class="text-blue-600 hover:text-blue-800">Create account</a>';
            resetPasswordElement.style.display = 'block';
        }

        const uiConfig = {
            signInOptions: [
                {
                    provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
                    requireDisplayName: mode === 'signup'
                }
            ],
            signInFlow: 'popup',
            callbacks: {
                signInSuccessWithAuthResult: async function(authResult) {
                    try {
                        // Get the ID token with force refresh to ensure it's new
                        const token = await firebase.auth().currentUser.getIdToken(true);
                        
                        // Set the auth token cookie with proper attributes
                        document.cookie = `auth_token=${token}; path=/; SameSite=Strict; max-age=3600`;
                        
                        // Make a request to sync the user with the backend
                        const response = await fetch('/sign-in', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({}) // Empty object as body
                        });

                        if (!response.ok) {
                            throw new Error('Failed to sync user with backend');
                        }

                        // Redirect based on whether the user is new or existing
                        if (authResult.additionalUserInfo.isNewUser) {
                            window.location.href = '/explore';
                        } else {
                            window.location.href = '/collection';
                        }
                        return false; // Prevent FirebaseUI from redirecting
                    } catch (error) {
                        console.error('Error in sign in success:', error);
                        alert('Error during sign in. Please try again.');
                        return false;
                    }
                },
                signInFailure: function(error) {
                    console.error('Sign-in failure:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        alert('An account already exists with this email. Please sign in instead.');
                        window.location.href = '/sign-in?mode=signin';
                    } else {
                        alert('Error during sign in: ' + error.message);
                    }
                    return false;
                }
            },
            tosUrl: '/terms',
            privacyPolicyUrl: '/privacy'
        };

        // Start the UI
        authUI.start('#firebaseui-auth-container', uiConfig);

        // Add password reset handler
        document.getElementById('reset-password').addEventListener('click', function(e) {
            e.preventDefault();
            const email = prompt('Please enter your email address:');
            if (email) {
                firebase.auth().sendPasswordResetEmail(email)
                    .then(() => {
                        alert('Password reset email sent! Please check your inbox.');
                    })
                    .catch((error) => {
                        console.error('Password reset error:', error);
                        if (error.code === 'auth/user-not-found') {
                            alert('No account found with this email address.');
                        } else {
                            alert('Error sending password reset email. Please try again.');
                        }
                    });
            }
        });
    });
</script>

<style>
    .firebaseui-container {
        max-width: 100% !important;
    }
    .firebaseui-card-content {
        padding: 20px !important;
    }
    .firebaseui-title {
        display: none !important;
    }
    .firebaseui-tos {
        text-align: center !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-md mx-auto mt-8">
    <div class="bg-white p-6 rounded shadow">
        <h1 id="auth-title" class="text-2xl mb-4 text-center">Sign In</h1>
        <p id="auth-description" class="text-gray-600 text-center mb-6">Welcome back! Sign in to access your collection</p>
        <div id="firebaseui-auth-container"></div>
        <div id="reset-password-container" class="text-center mt-4">
            <button id="reset-password" class="text-sm text-blue-600 hover:text-blue-800">Forgot password?</button>
        </div>
        <div id="switch-mode" class="text-center mt-4 text-sm">
            New to AI Card Creator? <a href="/sign-in?mode=signup" class="text-blue-600 hover:text-blue-800">Create account</a>
        </div>
    </div>
</div>
{% endblock %}