{% extends "base.html" %}

{% block title %}Open Pack - AI Card Creator{% endblock %}

{% block head %}
<style>
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #f3f3f3;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
    }

    .progress-bar-fill {
        height: 100%;
        background-color: #4CAF50;
        transition: width 0.3s ease;
    }

    .card-preview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }

    .card-placeholder {
        aspect-ratio: 7/10;
        background-color: #f3f3f3;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        color: #666;
    }
</style>

<script>
    let pollTimeout;
    const POLL_INTERVAL = 2000; // 2 seconds
    const MAX_POLL_TIME = 180000; // 3 minutes
    let packTasks = [];
    
    async function pollPackStatus(startTime) {
        try {
            if (!packTasks.length) return;
            
            // Check if we've exceeded max poll time
            if (Date.now() - startTime > MAX_POLL_TIME) {
                document.getElementById('error-message').textContent = "Operation timed out. Please try again.";
                document.getElementById('error-container').classList.remove('hidden');
                document.getElementById('loading-container').classList.add('hidden');
                return;
            }
            
            const response = await fetch(`/packs/status?${packTasks.map(id => `task_ids=${id}`).join('&')}`);
            if (!response.ok) throw new Error('Failed to check status');
            
            const data = await response.json();
            console.log('Status response:', data); // Debug log
            
            switch (data.status) {
                case 'completed':
                    if (data.cards && data.cards.length > 0) {
                        window.location.href = `/packs/result?${data.cards.map(card => `card_id=${card.id}`).join('&')}`;
                    } else {
                        throw new Error('No cards in response');
                    }
                    return;
                    
                case 'error':
                    const errorMessage = data.errors ? data.errors.join(', ') : "Failed to generate pack";
                    document.getElementById('error-message').textContent = errorMessage;
                    document.getElementById('error-container').classList.remove('hidden');
                    document.getElementById('loading-container').classList.add('hidden');
                    return;
                    
                case 'processing':
                    updateProgress(data.completed, data.total);
                    // Schedule next poll
                    pollTimeout = setTimeout(() => pollPackStatus(startTime), POLL_INTERVAL);
                    break;
                    
                default:
                    throw new Error(`Unknown status: ${data.status}`);
            }
        } catch (error) {
            console.error('Polling error:', error);
            document.getElementById('error-message').textContent = error.message;
            document.getElementById('error-container').classList.remove('hidden');
            document.getElementById('loading-container').classList.add('hidden');
        }
    }
    
    function updateProgress(completed, total) {
        const percentage = (completed / total) * 100;
        document.getElementById('progress-bar-fill').style.width = `${percentage}%`;
        document.getElementById('progress-text').textContent = 
            `Generating cards... ${completed} of ${total} complete`;
    }
    
    async function handleOpenPack(event) {
        event.preventDefault();
        
        // Clear any existing timeout
        if (pollTimeout) {
            clearTimeout(pollTimeout);
        }
        
        // Show loading state
        document.getElementById('form-container').classList.add('hidden');
        document.getElementById('loading-container').classList.remove('hidden');
        document.getElementById('error-container').classList.add('hidden');
        
        try {
            const response = await fetch('/packs', {
                method: 'POST'
            });
            
            if (!response.ok) {
                throw new Error('Failed to start pack opening');
            }
            
            const data = await response.json();
            console.log('Pack creation response:', data); // Debug log
            
            if (data.status === 'queued' && data.pack_tasks) {
                packTasks = data.pack_tasks;
                // Start polling with timestamp
                pollPackStatus(Date.now());
            } else {
                throw new Error('Invalid response from server');
            }
        } catch (error) {
            console.error('Submission error:', error);
            document.getElementById('error-message').textContent = error.message;
            document.getElementById('error-container').classList.remove('hidden');
            document.getElementById('loading-container').classList.add('hidden');
        }
    }
    
    // Cleanup on page unload
    window.addEventListener('unload', () => {
        if (pollTimeout) {
            clearTimeout(pollTimeout);
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Open a Pack</h1>
    
    <!-- Form Container -->
    <div id="form-container" class="bg-white rounded-lg shadow-lg p-6">
        <div class="bg-blue-50 p-4 rounded-md mb-6">
            <h3 class="text-blue-800 font-medium mb-2">What's in a pack?</h3>
            <ul class="text-blue-700 text-sm space-y-2">
                <li>• 1 Rare or Mythic Rare card</li>
                <li>• 3 Uncommon cards</li>
                <li>• 6 Common cards</li>
            </ul>
        </div>
        
        <button onclick="handleOpenPack(event)" class="w-full py-3 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">
            Open Pack
        </button>
    </div>
    
    <!-- Loading Container -->
    <div id="loading-container" class="hidden bg-white rounded-lg shadow-lg p-6">
        <div class="progress-bar">
            <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%"></div>
        </div>
        
        <p id="progress-text" class="text-center text-gray-600 mb-6">Starting pack opening...</p>
        
        <div class="card-preview">
            {% for _ in range(10) %}
            <div class="card-placeholder">
                Generating...
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Error Container -->
    <div id="error-container" class="hidden bg-white rounded-lg shadow-lg p-6">
        <div class="bg-red-50 p-4 rounded-md">
            <h3 class="text-red-800 font-medium mb-2">Error</h3>
            <p id="error-message" class="text-red-700"></p>
        </div>
        <button onclick="window.location.reload()" class="mt-4 w-full py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
            Try Again
        </button>
    </div>
</div>
{% endblock %}